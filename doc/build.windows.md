# Windows Build Instructions

This document illustrates the steps to build aeres on Windows.

## Prerequisite

 - Visual Studio 2017 Community or Professional with CMake support enabled

*Although it is possible to use cmake out of visual studio, it will be easier to use the builtin one so that additional setups for toolchain paths will not be needed. To check if the correct version is installed, open “Visual Studio Installer” from start menu, choose “Modify”, and make sure the cmake option in the detail information pane on the right is selected.*

## Build Steps

### Clone the source code

The aeres repository contains a few submodules that are required to build aeres. Make sure all submodules are synced before starting a build.

Run the following command to sync to the latest code:

```bash
$ git submodule init
$ git submodule update
```

### Clone the tools and dependency libraries

A toolchain repo is provided at `github.com:aeres-io/buildtools-win.git`. The easiest way to use it is to clone it side by side with the aeres repository. The folder structure should look like below after cloning this repository.

```
(some folder)
      |--- aeres
      |    |--- src
      |    |--- …
      |
      |--- buildtools-win
           |--- x86
           |--- x86_64
           |--- …
```

*The dependency libraries in this repository is built using Visual Studio 2017 Community. They have a dependency on the Visual C++ 2017 Redistributable package. If a different toolchain is preferred, create custom builds of OpenSSL and libcurl and put them in the same folder structure.*

### Install NASM/YASM

NASM/YASM is required to build the assembly code included in aeres project. Make sure file `%LOCALAPPDATA%\NASM\nasm.exe` or `%LOCALAPPDATA%\NASM\yasm.exe` exists.

[YASM](https://yasm.tortall.net/) can be found in `buildtools-win\[x86|x86_64]\yasm`. Copy the executable file to `%LOCALAPPDATA%\NASM` and rename it as `yasm.exe`.

*The architecture for yasm is only related to the build machine instead of the target build type that aeres is supposed to run at. Use x86 if the build machine is 32-bit or x86_64 if 64-bit.*

### Create the build (64-bit)

Open “x64 Native Tools Command Prompt for VS 2017” from start menu. Use `cd` to change the current working directory to the aeres folder. Then run the following command to create the build:

```
> md cmake.out
> cd cmake.out
> cmake -DCMAKE_GENERATOR_PLATFORM=x64 ..
> msbuild /p:Configuration=Release /p:Platform=x64 aeres_root.sln
```

*The solution and vcxproj files generated by cmake can also be opened and used in Visual Studio.*

### Create the build (32-bit)

Open “x86 Native Tools Command Prompt for VS 2017” from start menu. Use `cd` to change the current working directory to the aeres folder. Then run the following command to create the build:

```
> md cmake.out
> cd cmake.out
> cmake -DCMAKE_GENERATOR_PLATFORM=Win32 ..
> msbuild /p:Configuration=Release /p:Platform=Win32 aeres_root.sln
```

*The solution and vcxproj files generated by cmake can also be opened and used in Visual Studio.*

### Run the build result

Make sure the dependency dll files are copied to the same folder of aeres.exe in order to run the executable, including:
 
 - buildtools-win/[x86_64|x86]/openssl/bin/libeay32.dll
 - buildtools-win/[x86_64|x86]/openssl/bin/ssleay32.dll
 - buildtools-win/[x86_64|x86]/curl/bin/libcurl.dll
 - aeres/src/libquic/out/bin/quic.dll
 
*Visual C++ 2017 redist will also be needed to run the executable on another machine.*

### Create MSI Installation Package

MSI build script is available at `setup/msi`. [Wix Toolset](http://wixtoolset.org/) needs to be installed to create the MSI package.

Steps to build MSI package:

1. Build the binaries of the product first.

2. cd to setup/msi

3. Run the following command

```
build <arch>
```

*The argument arch should be `x86` for 32-bit build and `x64` for 64-bit build.*
